## 微信小程序底层架构

小程序运行环境分为渲染层，逻辑层；分别由两个线程管理；

渲染层的界面使用了webview进行渲染；一个小程序会有多个页面，所以渲染层会有多个webview线程

逻辑层采用jsCore线程运行js脚本

两个线程通信都经由微信客户端做中转，逻辑层发送网络请求也经由微信客户端进行转发

在渲染层，宿主环境会把WXML转化成对应的JS对象，在逻辑层发生数据变更的时候， 

我们需要通过宿主环境提供的setData方法把数据从逻辑层传递到渲染层，

再经过对比前后差异，把差异应用在原来的Dom树上，渲染出正确的UI界面

### 微信小程序与客户端的通讯原理

- 视图层组件

视图层与客户端的交互通信在ios和安卓系统中实现方式不一样

ios： 利用WKWebView 提供的messageHandles特性，

安卓： 往WebView的window对象注入一个原生方法；

最终封装到 WeiXinJSBridge兼容层，主要提供了调用，监听两个方法。

- 逻辑层接口

逻辑层与客户端原生通信机制与渲染层类似，不同在于，iOS平台可以往JavaScripCore框架注入一个全局的原生方法，而安卓方面则是跟渲染层一致的。

同样地，开发者也是间接地调用到与客户端原生通信的底层接口。一般我们会对逻辑层接口做层封装后才暴露给开发者，封装的细节可能是统一入参、做些参数校验、兼容各平台或版本问题等等。